<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soccer Central</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; background-color: #f4f7f6; color: #333; }
        h1, h2, h3 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 5px; margin-bottom: 15px; }
        .container { max-width: 1000px; margin: 0 auto; padding: 25px; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); background-color: #ffffff; }
        button { padding: 10px 18px; background-color: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; margin-right: 10px; font-size: 1rem; transition: background-color 0.3s ease; }
        button:hover { background-color: #2980b9; }
        input[type="date"], input[type="number"], input[type="text"], select { padding: 9px; border: 1px solid #ccc; border-radius: 5px; margin-right: 10px; font-size: 1rem; width: auto; max-width: 250px; }
        .section { margin-top: 35px; padding-top: 25px; border-top: 1px solid #eee; }
        #leagues-list, #fixtures-list, #standings-table, #team-details, #countries-list,
        #player-search-results, #team-stats-results, #player-stats-results, #events-results,
        #lineups-results, #h2h-results { margin-top: 20px; border: 1px solid #eee; padding: 18px; border-radius: 6px; background-color: #fdfdfd; }
        .league-item, .fixture-item, .country-item, .player-search-item, .h2h-match-item { margin-bottom: 8px; padding: 8px 0; border-bottom: 1px dotted #e0e0e0; display: flex; align-items: center; }
        .league-item:last-child, .fixture-item:last-child, .country-item:last-child, .player-search-item:last-child { border-bottom: none; }
        .league-item img, .fixture-item img, .team-logo-small { margin-right: 10px; vertical-align: middle; }
        .fixture-item div, .h2h-match-item div { flex: 1; }
        .fixture-item .teams, .h2h-match-item .teams { font-weight: bold; }
        .fixture-item .score, .h2h-match-item .score { margin-left: 10px; font-weight: bold; color: #007bff; }
        .fixture-item .status, .h2h-match-item .status { font-style: italic; color: #555; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.95rem; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background-color: #e9ecef; color: #333; }
        tr:nth-child(even) { background-color: #f8f8f8; }
        .error-message { color: #d9534f; background-color: #f2dede; border: 1px solid #ebccd1; padding: 12px; margin-top: 15px; border-radius: 5px; display: none; }
        .loading-message { font-style: italic; color: #888; margin-top: 15px; padding: 12px; display: none; background-color: #e7f3ff; border-radius: 5px; border: 1px solid #cce5ff; }
        .player-card, .event-card, .lineup-card { border: 1px solid #e0e0e0; padding: 15px; margin-bottom: 15px; border-radius: 6px; background-color: #ffffff; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .player-card h4, .event-card h4, .lineup-card h4 { margin-top: 0; color: #34495e; }
        .player-card ul, .event-card ul, .lineup-card ul { list-style: none; padding: 0; margin: 0; }
        .player-card ul li, .event-card ul li, .lineup-card ul li { margin-bottom: 5px; }
        .player-card strong, .event-card strong, .lineup-card strong { color: #555; }
        .event-card.goal { background-color: #d4edda; border-color: #c3e6cb; }
        .event-card.card { background-color: #fff3cd; border-color: #ffeeba; }
        .event-card.sub { background-color: #d1ecf1; border-color: #bee5eb; }
        .lineup-team { display: flex; align-items: center; margin-bottom: 15px; }
        .lineup-team img { margin-right: 15px; }
        .lineup-players { display: flex; flex-wrap: wrap; gap: 10px; }
        .lineup-player { background-color: #f0f8ff; border: 1px solid #d0e7f7; padding: 8px 12px; border-radius: 4px; font-size: 0.9em; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Soccer Central</h1>
        <p>Explore soccer data using the API-Sports Football API.</p>

        <div class="section">
            <h2>1. Browse Leagues</h2>
            <p>Search for leagues by name or country, or leave blank to load all (up to API limit).</p>
            <input type="text" id="league-search-input" placeholder="Enter league/country name">
            <button onclick="fetchLeagues()">Search Leagues</button>
            <div id="leagues-list">No leagues loaded yet.</div>
            <div id="leagues-error" class="error-message"></div>
            <div id="leagues-loading" class="loading-message"></div>
        </div>

        ---

        <div class="section">
            <h2>2. Browse Countries</h2>
            <button onclick="fetchCountries()">Load All Countries</button>
            <div id="countries-list">No countries loaded yet.</div>
            <div id="countries-error" class="error-message"></div>
            <div id="countries-loading" class="loading-message"></div>
        </div>

        ---

        <div class="section">
            <h2>3. Find Matches (Fixtures)</h2>
            <p>Select a league and a date to view matches.</p>
            <select id="fixture-league-select">
                <option value="">Loading Leagues...</option>
            </select>
            <input type="date" id="fixture-date-input" value="">
            <button onclick="fetchFixtures()">Load Matches</button>
            <div id="fixtures-list">No matches loaded yet.</div>
            <div id="fixtures-error" class="error-message"></div>
            <div id="fixtures-loading" class="loading-message"></div>
        </div>

        ---

        <div class="section">
            <h2>4. View League Standings</h2>
            <p>Select a league and season to see current standings.</p>
            <select id="standings-league-select">
                <option value="">Loading Leagues...</option>
            </select>
            <input type="number" id="standings-season-input" placeholder="Season (e.g., 2024)">
            <button onclick="fetchStandings()">Load Standings</button>
            <div id="standings-table">No standings loaded yet.</div>
            <div id="standings-error" class="error-message"></div>
            <div id="standings-loading" class="loading-message"></div>
        </div>

        ---

        <div class="section">
            <h2>5. Search for a Team</h2>
            <p>Enter a team name to find its details.</p>
            <input type="text" id="team-search-input" placeholder="Enter team name (e.g., Arsenal)">
            <button onclick="searchTeam()">Search Team</button>
            <div id="team-details">No team searched yet.</div>
            <div id="team-error" class="error-message"></div>
            <div id="team-loading" class="loading-message"></div>
        </div>

        ---

        <div class="section">
            <h2>6. Search for Players</h2>
            <p>Enter a player name to find them. (Note: Player search can be broad, narrow down by team/league for better results if possible.)</p>
            <input type="text" id="player-search-input" placeholder="Enter player name (e.g., Lionel Messi)">
            <button onclick="searchPlayers()">Search Players</button>
            <div id="player-search-results">No player searched yet.</div>
            <div id="player-search-error" class="error-message"></div>
            <div id="player-search-loading" class="loading-message"></div>
        </div>

        ---

        <div class="section">
            <h2>7. Team Statistics</h2>
            <p>Get statistics for a specific team in a league and season.</p>
            <input type="text" id="team-stat-team-name-input" placeholder="Enter Team Name (e.g., Manchester United)">
            <select id="team-stat-league-select">
                <option value="">Loading Leagues...</option>
            </select>
            <input type="number" id="team-stat-season-input" placeholder="Season (e.g., 2024)">
            <button onclick="fetchTeamStatistics()">Load Team Statistics</button>
            <div id="team-stats-results">No team statistics loaded.</div>
            <div id="team-stats-error" class="error-message"></div>
            <div id="team-stats-loading" class="loading-message"></div>
        </div>

        ---

        <div class="section">
            <h2>8. Player Statistics</h2>
            <p>Get statistics for a specific player in a league and season.</p>
            <input type="text" id="player-stat-player-name-input" placeholder="Enter Player Name (e.g., Erling Haaland)">
            <select id="player-stat-league-select">
                <option value="">Loading Leagues...</option>
            </select>
            <input type="number" id="player-stat-season-input" placeholder="Season (e.g., 2024)">
            <button onclick="fetchPlayerStatistics()">Load Player Statistics</button>
            <div id="player-stats-results">No player statistics loaded.</div>
            <div id="player-stats-error" class="error-message"></div>
            <div id="player-stats-loading" class="loading-message"></div>
        </div>

        ---

        <div class="section">
            <h2>9. Match Events</h2>
            <p>View events (goals, cards, substitutions) for a specific match.</p>
            <input type="text" id="events-home-team-name" placeholder="Home Team Name (e.g., Real Madrid)">
            <input type="text" id="events-away-team-name" placeholder="Away Team Name (e.g., Barcelona)">
            <input type="date" id="events-fixture-date" value="">
            <button onclick="fetchEvents()">Load Events</button>
            <div id="events-results">No events loaded.</div>
            <div id="events-error" class="error-message"></div>
            <div id="events-loading" class="loading-message"></div>
        </div>

        ---

        <div class="section">
            <h2>10. Match Lineups</h2>
            <p>View team lineups for a specific match.</p>
            <input type="text" id="lineups-home-team-name" placeholder="Home Team Name (e.g., Liverpool)">
            <input type="text" id="lineups-away-team-name" placeholder="Away Team Name (e.g., Man City)">
            <input type="date" id="lineups-fixture-date" value="">
            <button onclick="fetchLineups()">Load Lineups</button>
            <div id="lineups-results">No lineups loaded.</div>
            <div id="lineups-error" class="error-message"></div>
            <div id="lineups-loading" class="loading-message"></div>
        </div>

        ---

        <div class="section">
            <h2>11. Head-to-Head (H2H) Matches</h2>
            <p>Find past matches between two teams.</p>
            <input type="text" id="h2h-team1-name" placeholder="Team 1 Name (e.g., Chelsea)">
            <input type="text" id="h2h-team2-name" placeholder="Team 2 Name (e.g., Tottenham)">
            <button onclick="fetchH2H()">Load H2H</button>
            <div id="h2h-results">No H2H matches loaded.</div>
            <div id="h2h-error" class="error-message"></div>
            <div id="h2h-loading" class="loading-message"></div>
        </div>

    </div>

    <script>
        

        async function apiRequest(endpoint, params, loadingElId, errorElId, displayFunction) {
            hideMessage(errorElId);
            showMessage(loadingElId, 'Loading...', false);

            const url = getApiUrl(endpoint, params);
            const headers = {
                "x-rapidapi-host": RAPIDAPI_HOST,
                "x-rapidapi-key": RAPIDAPI_KEY
            };

            try {
                const response = await fetch(url, { headers: headers });
                const data = await response.json();
                hideMessage(loadingElId);

                if (data.errors && Object.keys(data.errors).length > 0) {
                    const errorMsg = Object.values(data.errors).join(', ') || 'An API error occurred.';
                    showMessage(errorElId, `API Error: ${errorMsg}. Please check your inputs or API limits.`, true);
                    return null; // Return null on API errors
                }

                if (data.response && data.response.length > 0) {
                    displayFunction(data.response);
                    return data.response; // Return data on success
                } else {
                    displayFunction([]);
                    return []; // Return empty array if no data
                }
            } catch (error) {
                hideMessage(loadingElId);
                showMessage(errorElId, `Network Error: ${error.message}. Check console for details (CORS, internet, etc.).`, true);
                console.error(`Error fetching ${endpoint}:`, error);
                return null; // Return null on network errors
            }
        }

        function showMessage(elementId, message, isError = false) {
            const el = document.getElementById(elementId);
            if (el) {
                el.innerText = message;
                el.style.display = 'block';
                el.style.backgroundColor = isError ? '#f8d7da' : '#d4edda';
                el.style.color = isError ? '#721c24' : '#155724';
                el.style.borderColor = isError ? '#f5c6cb' : '#c3e6cb';
            }
        }

        function hideMessage(elementId) {
            const el = document.getElementById(elementId);
            if (el) { el.style.display = 'none'; }
        }

        // --- HELPER FUNCTION TO RESOLVE NAME TO ID ---
        async function resolveNameToId(searchEndpoint, searchName, type, errorElId, searchParams = {}) {
            if (!searchName) {
                showMessage(errorElId, `Please enter a ${type} name.`, true);
                return null;
            }

            const params = { search: searchName, ...searchParams }; // Combine base search with any extra params (e.g., league for players/teams if needed)
            const url = getApiUrl(searchEndpoint, params);
            const headers = {
                "x-rapidapi-host": RAPIDAPI_HOST,
                "x-rapidapi-key": RAPIDAPI_KEY
            };

            try {
                const response = await fetch(url, { headers: headers });
                const data = await response.json();

                if (data.errors && Object.keys(data.errors).length > 0) {
                    const errorMsg = Object.values(data.errors).join(', ') || `Failed to search for ${type}.`;
                    showMessage(errorElId, `API Error searching ${type}: ${errorMsg}.`, true);
                    return null;
                }

                if (data.response && data.response.length > 0) {
                    const item = data.response[0]; // For demo, pick the first result
                    let id;
                    let nameFound;

                    if (type === 'team') {
                        id = item.team.id;
                        nameFound = item.team.name;
                    } else if (type === 'player') {
                        id = item.player.id;
                        nameFound = item.player.name;
                    } else if (type === 'fixture') {
                         id = item.fixture.id;
                         nameFound = `${item.teams.home.name} vs ${item.teams.away.name}`;
                    }


                    if (data.response.length > 1) {
                        console.warn(`Multiple ${type}s found for "${searchName}". Using the first one: ${nameFound} (ID: ${id}).`);
                        // Optionally: show a mild warning to the user, e.g., "Multiple matches found, showing data for [Name]"
                    }
                    return id;
                } else {
                    showMessage(errorElId, `No ${type} found matching "${searchName}".`, true);
                    return null;
                }
            } catch (error) {
                showMessage(errorElId, `Network Error searching for ${type}: ${error.message}.`, true);
                console.error(`Error searching ${type}:`, error);
                return null;
            }
        }

        async function populateAllLeagueDropdowns() {
            const fixtureLeagueSelect = document.getElementById('fixture-league-select');
            const standingsLeagueSelect = document.getElementById('standings-league-select');
            const teamStatLeagueSelect = document.getElementById('team-stat-league-select');
            const playerStatLeagueSelect = document.getElementById('player-stat-league-select');

            fixtureLeagueSelect.innerHTML = '<option value="">Loading Leagues...</option>';
            standingsLeagueSelect.innerHTML = '<option value="">Loading Leagues...</option>';
            teamStatLeagueSelect.innerHTML = '<option value="">Loading Leagues...</option>';
            playerStatLeagueSelect.innerHTML = '<option value="">Loading Leagues...</option>';

            const url = getApiUrl('leagues');
            const headers = {
                "x-rapidapi-host": RAPIDAPI_HOST,
                "x-rapidapi-key": RAPIDAPI_KEY
            };

            try {
                const response = await fetch(url, { headers: headers });
                const data = await response.json();

                if (data.errors && Object.keys(data.errors).length > 0) {
                    const errorMsg = Object.values(data.errors).join(', ') || 'Failed to load leagues for dropdowns.';
                    fixtureLeagueSelect.innerHTML = `<option value="">Error loading leagues</option>`;
                    standingsLeagueSelect.innerHTML = `<option value="">Error loading leagues</option>`;
                    teamStatLeagueSelect.innerHTML = `<option value="">Error loading leagues</option>`;
                    playerStatLeagueSelect.innerHTML = `<option value="">Error loading leagues</option>`;
                    console.error("Error populating league dropdowns:", errorMsg);
                    return;
                }

                if (data.response && data.response.length > 0) {
                    const leagues = data.response;

                    fixtureLeagueSelect.innerHTML = '<option value="">Select a League</option>';
                    standingsLeagueSelect.innerHTML = '<option value="">Select a League</option>';
                    teamStatLeagueSelect.innerHTML = '<option value="">Select a League</option>';
                    playerStatLeagueSelect.innerHTML = '<option value="">Select a League (Optional)</option>';

                    leagues.forEach(item => {
                        const leagueName = item.league.name;
                        const leagueId = item.league.id;
                        const option = document.createElement('option');
                        option.value = leagueId;
                        option.textContent = leagueName;
                        fixtureLeagueSelect.appendChild(option.cloneNode(true));
                        standingsLeagueSelect.appendChild(option.cloneNode(true));
                        teamStatLeagueSelect.appendChild(option.cloneNode(true));
                        playerStatLeagueSelect.appendChild(option.cloneNode(true));
                    });
                } else {
                    fixtureLeagueSelect.innerHTML = `<option value="">No leagues found</option>`;
                    standingsLeagueSelect.innerHTML = `<option value="">No leagues found</option>`;
                    teamStatLeagueSelect.innerHTML = `<option value="">No leagues found</option>`;
                    playerStatLeagueSelect.innerHTML = `<option value="">No leagues found</option>`;
                }
            } catch (error) {
                fixtureLeagueSelect.innerHTML = `<option value="">Network Error</option>`;
                standingsLeagueSelect.innerHTML = `<option value="">Network Error</option>`;
                teamStatLeagueSelect.innerHTML = `<option value="">Network Error</option>`;
                playerStatLeagueSelect.innerHTML = `<option value="">Network Error</option>`;
                console.error("Error fetching leagues for dropdowns:", error);
            }
        }


        // --- FETCH LEAGUES (for the Browse Leagues section only) ---
        async function fetchLeagues() {
            const leaguesListDiv = document.getElementById('leagues-list');
            leaguesListDiv.innerHTML = '';
            const searchInput = document.getElementById('league-search-input').value.trim();

            const params = {};
            if (searchInput) {
                params.search = searchInput;
            }

            await apiRequest(
                'leagues',
                params,
                'leagues-loading',
                'leagues-error',
                (response) => {
                    if (response && response.length > 0) {
                        leaguesListDiv.innerHTML = `<h3>${searchInput ? 'Search Results' : 'All Leagues'}:</h3>`;
                        response.forEach(item => {
                            const leagueName = item.league.name;
                            const leagueId = item.league.id;
                            const countryName = item.country.name;
                            const logo = item.league.logo;
                            const type = item.league.type;
                            const currentSeason = item.seasons.find(s => s.current);

                            const p = document.createElement('p');
                            p.className = 'league-item';
                            p.innerHTML = `<img src="${logo}" alt="${leagueName} logo" width="20" height="20"> <strong>${leagueName}</strong> (${countryName}) - ID: ${leagueId} (Type: ${type})`;
                            if (currentSeason) {
                                p.innerHTML += ` - Current Season: ${currentSeason.year}`;
                            }
                            leaguesListDiv.appendChild(p);
                        });
                    } else {
                        leaguesListDiv.innerText = `No leagues found ${searchInput ? `matching "${searchInput}"` : ''}.`;
                    }
                }
            );
        }

        // --- FETCH COUNTRIES ---
        async function fetchCountries() {
            const countriesListDiv = document.getElementById('countries-list');
            countriesListDiv.innerHTML = '';

            await apiRequest(
                'countries',
                {},
                'countries-loading',
                'countries-error',
                (response) => {
                    if (response && response.length > 0) {
                        countriesListDiv.innerHTML = `<h3>Available Countries:</h3>`;
                        response.forEach(country => {
                            const p = document.createElement('p');
                            p.className = 'country-item';
                            p.innerHTML = `<img src="${country.flag}" alt="${country.name} flag" width="20" height="15"> <strong>${country.name}</strong> (Code: ${country.code})`;
                            countriesListDiv.appendChild(p);
                        });
                    } else {
                        countriesListDiv.innerText = "No countries found.";
                    }
                }
            );
        }

        // --- FETCH FIXTURES (GAMES) ---
        async function fetchFixtures() {
            const fixturesListDiv = document.getElementById('fixtures-list');
            fixturesListDiv.innerHTML = '';
            const leagueId = document.getElementById('fixture-league-select').value;
            const dateInput = document.getElementById('fixture-date-input').value;
            const currentYear = new Date().getFullYear();

            if (!leagueId || !dateInput) {
                showMessage('fixtures-error', 'Please select both a league and a date.', true);
                return;
            }

            await apiRequest(
                'fixtures',
                { league: leagueId, season: currentYear, date: dateInput },
                'fixtures-loading',
                'fixtures-error',
                (response) => {
                    if (response && response.length > 0) {
                        fixturesListDiv.innerHTML = `<h3>Matches on ${dateInput} for selected League:</h3>`;
                        response.forEach(fixture => {
                            const homeTeam = fixture.teams.home.name;
                            const awayTeam = fixture.teams.away.name;
                            const homeLogo = fixture.teams.home.logo;
                            const awayLogo = fixture.teams.away.logo;
                            const scoreHome = fixture.goals.home !== null ? fixture.goals.home : '?';
                            const scoreAway = fixture.goals.away !== null ? fixture.goals.away : '?';
                            const status = fixture.fixture.status.long;
                            const venue = fixture.fixture.venue.name;
                            const time = new Date(fixture.fixture.date).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                            const fixtureId = fixture.fixture.id; // Still show fixture ID here for reference

                            const fixtureDiv = document.createElement('div');
                            fixtureDiv.className = 'fixture-item';
                            fixtureDiv.innerHTML = `
                                <div>
                                    <img src="${homeLogo}" alt="${homeTeam} logo" width="20" height="20">
                                    <span class="teams">${homeTeam}</span>
                                    <span class="score">${scoreHome} - ${scoreAway}</span>
                                    <span class="teams">${awayTeam}</span>
                                    <img src="${awayLogo}" alt="${awayTeam} logo" width="20" height="20">
                                </div>
                                <div>
                                    <span>${time}</span> | <span>${venue}</span> | <span class="status">${status}</span>
                                    <p style="font-size:0.8em; margin:0; padding-top:5px;">Fixture ID: ${fixtureId}</p>
                                </div>
                            `;
                            fixturesListDiv.appendChild(fixtureDiv);
                        });
                    } else {
                        fixturesListDiv.innerText = `No matches found for the selected league and date (${dateInput}).`;
                    }
                }
            );
        }

        // --- FETCH STANDINGS ---
        async function fetchStandings() {
            const standingsTableDiv = document.getElementById('standings-table');
            standingsTableDiv.innerHTML = '';
            const leagueId = document.getElementById('standings-league-select').value;
            const season = document.getElementById('standings-season-input').value;

            if (!leagueId || !season) {
                showMessage('standings-error', 'Please select a league and enter a season year.', true);
                return;
            }

            await apiRequest(
                'standings',
                { league: leagueId, season: season },
                'standings-loading',
                'standings-error',
                (response) => {
                    if (response && response.length > 0 && response[0].league && response[0].league.standings && response[0].league.standings.length > 0) {
                        const standings = response[0].league.standings[0];

                        let tableHTML = `
                            <h3>${response[0].league.name} Standings - ${season}</h3>
                            <table>
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Team</th>
                                        <th>Played</th>
                                        <th>Won</th>
                                        <th>Drawn</th>
                                        <th>Lost</th>
                                        <th>GF</th>
                                        <th>GA</th>
                                        <th>GD</th>
                                        <th>Points</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;

                        standings.sort((a, b) => a.rank - b.rank);
                        standings.forEach(team => {
                            tableHTML += `
                                <tr>
                                    <td>${team.rank}</td>
                                    <td><img src="${team.team.logo}" alt="${team.team.name} logo" class="team-logo-small" width="20" height="20">${team.team.name}</td>
                                    <td>${team.all.played}</td>
                                    <td>${team.all.win}</td>
                                    <td>${team.all.draw}</td>
                                    <td>${team.all.lose}</td>
                                    <td>${team.all.goals.for}</td>
                                    <td>${team.all.goals.against}</td>
                                    <td>${team.goalsDiff}</td>
                                    <td>${team.points}</td>
                                </tr>
                            `;
                        });

                        tableHTML += `
                                </tbody>
                            </table>
                        `;
                        standingsTableDiv.innerHTML = tableHTML;
                    } else {
                        standingsTableDiv.innerText = `No standings found for the selected league and season (${season}).`;
                    }
                }
            );
        }

        // --- SEARCH TEAM ---
        async function searchTeam() {
            const teamDetailsDiv = document.getElementById('team-details');
            teamDetailsDiv.innerHTML = '';
            const teamName = document.getElementById('team-search-input').value.trim();

            if (!teamName) {
                showMessage('team-error', 'Please enter a team name.', true);
                return;
            }

            await apiRequest(
                'teams',
                { search: teamName },
                'team-loading',
                'team-error',
                (response) => {
                    if (response && response.length > 0) {
                        const team = response[0].team;
                        const venue = response[0].venue;

                        teamDetailsDiv.innerHTML = `
                            <h3><img src="${team.logo}" alt="${team.name} logo" width="40" height="40" style="vertical-align: middle; margin-right: 10px;">${team.name}</h3>
                            <p><strong>Team ID:</strong> ${team.id}</p>
                            <p><strong>Country:</strong> ${team.country}</p>
                            <p><strong>Founded:</strong> ${team.founded}</p>
                            ${venue ? `
                                <h4>Venue Details:</h4>
                                <p><strong>Name:</strong> ${venue.name}</p>
                                <p><strong>City:</strong> ${venue.city}</p>
                                <p><strong>Capacity:</strong> ${venue.capacity}</p>
                                <p><strong>Address:</strong> ${venue.address}</p>
                                <img src="${venue.image}" alt="${venue.name} stadium" width="200" style="margin-top: 10px; border-radius: 5px;">
                            ` : '<p>No venue details available.</p>'}
                        `;
                    } else {
                        teamDetailsDiv.innerText = `No team found matching "${teamName}".`;
                    }
                }
            );
        }

        // --- SEARCH PLAYERS ---
        async function searchPlayers() {
            const playerSearchResultsDiv = document.getElementById('player-search-results');
            playerSearchResultsDiv.innerHTML = '';
            const playerName = document.getElementById('player-search-input').value.trim();

            if (!playerName) {
                showMessage('player-search-error', 'Please enter a player name.', true);
                return;
            }

            await apiRequest(
                'players',
                { search: playerName },
                'player-search-loading',
                'player-search-error',
                (response) => {
                    if (response && response.length > 0) {
                        playerSearchResultsDiv.innerHTML = `<h3>Players matching "${playerName}":</h3>`;
                        response.forEach(playerData => {
                            const player = playerData.player;
                            const statistics = playerData.statistics[0];

                            let playerHtml = `
                                <div class="player-search-item">
                                    <img src="${player.photo}" alt="${player.name} photo" width="50" height="50" style="border-radius: 50%; object-fit: cover; margin-right: 15px;">
                                    <div>
                                        <strong>${player.name}</strong> (ID: ${player.id})<br>
                                        Nationality: ${player.nationality || 'N/A'}<br>
                                        Birth: ${player.birth.date || 'N/A'} in ${player.birth.place || 'N/A'}, ${player.birth.country || 'N/A'}<br>
                                        ${statistics ? `Team: <img src="${statistics.team.logo}" alt="${statistics.team.name} logo" width="15" height="15" class="team-logo-small"> ${statistics.team.name} | League: ${statistics.league.name}` : ''}
                                    </div>
                                </div>
                            `;
                            playerSearchResultsDiv.innerHTML += playerHtml;
                        });
                    } else {
                        playerSearchResultsDiv.innerText = `No players found matching "${playerName}".`;
                    }
                }
            );
        }

        // --- FETCH TEAM STATISTICS (NOW BY NAME) ---
        async function fetchTeamStatistics() {
            const teamStatsResultsDiv = document.getElementById('team-stats-results');
            teamStatsResultsDiv.innerHTML = '';
            const teamName = document.getElementById('team-stat-team-name-input').value.trim();
            const leagueId = document.getElementById('team-stat-league-select').value;
            const season = document.getElementById('team-stat-season-input').value;

            if (!teamName || !leagueId || !season) {
                showMessage('team-stats-error', 'Please enter Team Name, select a League, and enter a Season.', true);
                return;
            }

            // Step 1: Resolve Team Name to Team ID
            const teamId = await resolveNameToId('teams', teamName, 'team', 'team-stats-error');
            if (!teamId) {
                hideMessage('team-stats-loading');
                return; // Error message already shown by resolveNameToId
            }

            // Step 2: Use the resolved Team ID to fetch statistics
            await apiRequest(
                'teams/statistics',
                { team: teamId, league: leagueId, season: season },
                'team-stats-loading',
                'team-stats-error',
                (response) => {
                    if (response && response.length > 0) {
                        const stats = response[0];
                        teamStatsResultsDiv.innerHTML = `
                            <h3><img src="${stats.team.logo}" alt="${stats.team.name} logo" width="30" height="30" class="team-logo-small"> ${stats.team.name} Statistics (${stats.league.name} ${stats.season} Season)</h3>
                            <p><strong>Games Played:</strong> ${stats.fixtures.played.total}</p>
                            <p><strong>Wins:</strong> ${stats.fixtures.wins.total} | <strong>Draws:</strong> ${stats.fixtures.draws.total} | <strong>Losses:</strong> ${stats.fixtures.loses.total}</p>
                            <p><strong>Goals For:</strong> ${stats.goals.for.total.total} | <strong>Goals Against:</strong> ${stats.goals.against.total.total}</p>
                            <p><strong>Clean Sheets:</strong> ${stats.clean_sheet.total}</p>
                            <h4>Form:</h4>
                            <p>${stats.form}</p>
                            <h4>Cards:</h4>
                            <ul>
                                <li>Yellow: ${stats.cards.yellow.total || 0}</li>
                                <li>Red: ${stats.cards.red.total || 0}</li>
                            </ul>
                            <h4>Lineups (Most Used Formation):</h4>
                            ${stats.lineups && stats.lineups.length > 0 ? `
                                <p>Formation: ${stats.lineups[0].formation} (${stats.lineups[0].played} times)</p>
                            ` : '<p>No lineup data available.</p>'}
                        `;
                    } else {
                        teamStatsResultsDiv.innerText = `No statistics found for Team: "${teamName}" in selected league/season.`;
                    }
                }
            );
        }

        // --- FETCH PLAYER STATISTICS (NOW BY NAME) ---
        async function fetchPlayerStatistics() {
            const playerStatsResultsDiv = document.getElementById('player-stats-results');
            playerStatsResultsDiv.innerHTML = '';
            const playerName = document.getElementById('player-stat-player-name-input').value.trim();
            const leagueId = document.getElementById('player-stat-league-select').value;
            const season = document.getElementById('player-stat-season-input').value;

            if (!playerName || !season) {
                showMessage('player-stats-error', 'Please enter Player Name and Season. League is optional.', true);
                return;
            }

            // Step 1: Resolve Player Name to Player ID
            const playerId = await resolveNameToId('players', playerName, 'player', 'player-stats-error');
            if (!playerId) {
                hideMessage('player-stats-loading');
                return; // Error message already shown by resolveNameToId
            }

            // Step 2: Use the resolved Player ID to fetch statistics
            const params = { player: playerId, season: season };
            if (leagueId) {
                params.league = leagueId;
            }

            await apiRequest(
                'players',
                params,
                'player-stats-loading',
                'player-stats-error',
                (response) => {
                    if (response && response.length > 0 && response[0].statistics && response[0].statistics.length > 0) {
                        const player = response[0].player;
                        const stats = response[0].statistics[0];

                        playerStatsResultsDiv.innerHTML = `
                            <h3><img src="${player.photo}" alt="${player.name} photo" width="50" height="50" style="border-radius: 50%; object-fit: cover; margin-right: 15px;"> ${player.name} (${player.nationality})</h3>
                            <p><strong>Player ID:</strong> ${player.id}</p>
                            <p><strong>Age:</strong> ${player.age || 'N/A'} | <strong>Height:</strong> ${player.height || 'N/A'} | <strong>Weight:</strong> ${player.weight || 'N/A'}</p>
                            <h4>Statistics for ${stats.league.name} (${stats.season} Season) - <img src="${stats.team.logo}" alt="${stats.team.name} logo" width="20" height="20" class="team-logo-small"> ${stats.team.name}</h4>
                            <ul>
                                <li><strong>Position:</strong> ${stats.games.position}</li>
                                <li><strong>Appearances:</strong> ${stats.games.appearances || 0}</li>
                                <li><strong>Minutes Played:</strong> ${stats.games.minutes || 0}</li>
                                <li><strong>Rating:</strong> ${stats.games.rating || 'N/A'}</li>
                                <li><strong>Goals:</strong> ${stats.goals.total || 0}</li>
                                <li><strong>Assists:</strong> ${stats.goals.assists || 0}</li>
                                <li><strong>Pass Accuracy:</strong> ${stats.passes.accuracy || 0}%</li>
                                <li><strong>Tackles:</strong> ${stats.tackles.total || 0}</li>
                                <li><strong>Cards:</strong> Yellow ${stats.cards.yellow || 0}, Red ${stats.cards.red || 0}</li>
                            </ul>
                        `;
                    } else {
                        playerStatsResultsDiv.innerText = `No statistics found for Player: "${playerName}" in selected season/league.`;
                    }
                }
            );
        }

        // --- FETCH EVENTS (NOW BY TEAM NAMES AND DATE) ---
        async function fetchEvents() {
            const eventsResultsDiv = document.getElementById('events-results');
            eventsResultsDiv.innerHTML = '';
            const homeTeamName = document.getElementById('events-home-team-name').value.trim();
            const awayTeamName = document.getElementById('events-away-team-name').value.trim();
            const fixtureDate = document.getElementById('events-fixture-date').value;

            if (!homeTeamName || !awayTeamName || !fixtureDate) {
                showMessage('events-error', 'Please enter both team names and a date to find the match.', true);
                return;
            }

            // Step 1: Find the fixture ID using team names and date
            // Note: API-Sports fixtures endpoint requires a league or season for basic search,
            // or specific team IDs/names + date. We'll search by team names and date.
            // This search might return multiple fixtures if the same teams play multiple times on the same day in different leagues.
            const fixtureSearchParams = {
                home: homeTeamName,
                away: awayTeamName,
                date: fixtureDate,
                season: new Date().getFullYear() // Default to current year for demo simplicity
            };

            const fixtureId = await resolveNameToId('fixtures', `${homeTeamName} vs ${awayTeamName}`, 'fixture', 'events-error', fixtureSearchParams);

            if (!fixtureId) {
                hideMessage('events-loading');
                return;
            }

            // Step 2: Use the resolved Fixture ID to fetch events
            await apiRequest(
                'fixtures/events',
                { fixture: fixtureId },
                'events-loading',
                'events-error',
                (response) => {
                    if (response && response.length > 0) {
                        eventsResultsDiv.innerHTML = `<h3>Events for Fixture ID: ${fixtureId} (${homeTeamName} vs ${awayTeamName} on ${fixtureDate})</h3>`;
                        response.forEach(event => {
                            let eventClass = '';
                            if (event.type === 'Goal') eventClass = 'goal';
                            else if (event.type === 'Card') eventClass = 'card';
                            else if (event.type === 'subst') eventClass = 'sub';

                            eventsResultsDiv.innerHTML += `
                                <div class="event-card ${eventClass}">
                                    <h4>${event.time.elapsed}' ${event.type} by ${event.player.name} (${event.team.name})</h4>
                                    <ul>
                                        <li><strong>Detail:</strong> ${event.detail || 'N/A'}</li>
                                        <li><strong>Comments:</strong> ${event.comments || 'N/A'}</li>
                                        ${event.assist ? `<li><strong>Assist:</strong> ${event.assist.name}</li>` : ''}
                                    </ul>
                                </div>
                            `;
                        });
                    } else {
                        eventsResultsDiv.innerText = `No events found for the match "${homeTeamName} vs ${awayTeamName}" on ${fixtureDate}.`;
                    }
                }
            );
        }

        // --- FETCH LINEUPS (NOW BY TEAM NAMES AND DATE) ---
        async function fetchLineups() {
            const lineupsResultsDiv = document.getElementById('lineups-results');
            lineupsResultsDiv.innerHTML = '';
            const homeTeamName = document.getElementById('lineups-home-team-name').value.trim();
            const awayTeamName = document.getElementById('lineups-away-team-name').value.trim();
            const fixtureDate = document.getElementById('lineups-fixture-date').value;

            if (!homeTeamName || !awayTeamName || !fixtureDate) {
                showMessage('lineups-error', 'Please enter both team names and a date to find the match.', true);
                return;
            }

            // Step 1: Find the fixture ID using team names and date
            const fixtureSearchParams = {
                home: homeTeamName,
                away: awayTeamName,
                date: fixtureDate,
                season: new Date().getFullYear() // Default to current year for demo simplicity
            };

            const fixtureId = await resolveNameToId('fixtures', `${homeTeamName} vs ${awayTeamName}`, 'fixture', 'lineups-error', fixtureSearchParams);

            if (!fixtureId) {
                hideMessage('lineups-loading');
                return;
            }

            // Step 2: Use the resolved Fixture ID to fetch lineups
            await apiRequest(
                'fixtures/lineups',
                { fixture: fixtureId },
                'lineups-loading',
                'lineups-error',
                (response) => {
                    if (response && response.length > 0) {
                        lineupsResultsDiv.innerHTML = `<h3>Lineups for Fixture ID: ${fixtureId} (${homeTeamName} vs ${awayTeamName} on ${fixtureDate})</h3>`;
                        response.forEach(teamLineup => {
                            lineupsResultsDiv.innerHTML += `
                                <div class="lineup-team">
                                    <img src="${teamLineup.team.logo}" alt="${teamLineup.team.name} logo" width="40" height="40">
                                    <h4>${teamLineup.team.name} (${teamLineup.formation || 'Formation N/A'})</h4>
                                </div>
                                <h5>Start XI:</h5>
                                <div class="lineup-players">
                                    ${teamLineup.startXI.map(p => `<span class="lineup-player">${p.player.name} (#${p.player.number}, ${p.player.pos})</span>`).join('')}
                                </div>
                                <h5>Substitutes:</h5>
                                <div class="lineup-players">
                                    ${teamLineup.substitutes.map(p => `<span class="lineup-player">${p.player.name} (#${p.player.number}, ${p.player.pos})</span>`).join('')}
                                </div>
                                <hr style="margin: 20px 0;">
                            `;
                        });
                    } else {
                        lineupsResultsDiv.innerText = `No lineups found for the match "${homeTeamName} vs ${awayTeamName}" on ${fixtureDate}.`;
                    }
                }
            );
        }

        // --- FETCH HEAD-TO-HEAD (NOW BY TEAM NAMES) ---
        async function fetchH2H() {
            const h2hResultsDiv = document.getElementById('h2h-results');
            h2hResultsDiv.innerHTML = '';
            const team1Name = document.getElementById('h2h-team1-name').value.trim();
            const team2Name = document.getElementById('h2h-team2-name').value.trim();

            if (!team1Name || !team2Name) {
                showMessage('h2h-error', 'Please enter names for both Team 1 and Team 2.', true);
                return;
            }
            if (team1Name.toLowerCase() === team2Name.toLowerCase()) {
                showMessage('h2h-error', 'Team names must be different for Head-to-Head.', true);
                return;
            }

            // Step 1: Resolve Team Names to Team IDs
            const team1Id = await resolveNameToId('teams', team1Name, 'team', 'h2h-error');
            if (!team1Id) {
                hideMessage('h2h-loading');
                return;
            }
            const team2Id = await resolveNameToId('teams', team2Name, 'team', 'h2h-error');
            if (!team2Id) {
                hideMessage('h2h-loading');
                return;
            }

            const h2hParam = `${team1Id}-${team2Id}`;

            // Step 2: Use the resolved Team IDs to fetch H2H fixtures
            await apiRequest(
                'fixtures/headtohead',
                { h2h: h2hParam },
                'h2h-loading',
                'h2h-error',
                (response) => {
                    if (response && response.length > 0) {
                        h2hResultsDiv.innerHTML = `<h3>Head-to-Head Matches:</h3>`;
                        response.forEach(fixture => {
                            const homeTeam = fixture.teams.home.name;
                            const awayTeam = fixture.teams.away.name;
                            const homeLogo = fixture.teams.home.logo;
                            const awayLogo = fixture.teams.away.logo;
                            const scoreHome = fixture.goals.home !== null ? fixture.goals.home : '?';
                            const scoreAway = fixture.goals.away !== null ? fixture.goals.away : '?';
                            const status = fixture.fixture.status.long;
                            const date = new Date(fixture.fixture.date).toLocaleDateString();
                            const leagueName = fixture.league.name;

                            h2hResultsDiv.innerHTML += `
                                <div class="h2h-match-item">
                                    <div>
                                        <img src="${homeLogo}" alt="${homeTeam} logo" width="20" height="20">
                                        <span class="teams">${homeTeam}</span>
                                        <span class="score">${scoreHome} - ${scoreAway}</span>
                                        <span class="teams">${awayTeam}</span>
                                        <img src="${awayLogo}" alt="${awayTeam} logo" width="20" height="20">
                                    </div>
                                    <div>
                                        <span>${date}</span> | <span>${leagueName}</span> | <span class="status">${status}</span>
                                    </div>
                                </div>
                            `;
                        });
                    } else {
                        h2hResultsDiv.innerText = `No Head-to-Head matches found between "${team1Name}" and "${team2Name}".`;
                    }
                }
            );
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            document.getElementById('fixture-date-input').value = `${year}-${month}-${day}`;
            document.getElementById('standings-season-input').value = year;
            document.getElementById('team-stat-season-input').value = year;
            document.getElementById('player-stat-season-input').value = year;
            document.getElementById('events-fixture-date').value = `${year}-${month}-${day}`; // Default for events/lineups
            document.getElementById('lineups-fixture-date').value = `${year}-${month}-${day}`;

            populateAllLeagueDropdowns();
        });
    </script>
</body>
</html>